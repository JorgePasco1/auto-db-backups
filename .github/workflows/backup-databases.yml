name: Backup Neon Databases

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup-all:
    name: Backup All Databases
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build and run backup
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          DATABASE_TYPE: postgres
          DATABASE_CONNECTION_1: ${{ secrets.DATABASE_CONNECTION_1 }}
          DATABASE_NAME_1: ${{ secrets.DATABASE_NAME_1 }}
          DATABASE_CONNECTION_2: ${{ secrets.DATABASE_CONNECTION_2 }}
          DATABASE_NAME_2: ${{ secrets.DATABASE_NAME_2 }}
          DATABASE_CONNECTION_3: ${{ secrets.DATABASE_CONNECTION_3 }}
          DATABASE_NAME_3: ${{ secrets.DATABASE_NAME_3 }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          COMPRESSION: true
          RETENTION_DAYS: 7
          RETENTION_COUNT: 30
        run: |
          go build -o auto-db-backups .
          ./auto-db-backups
