name: Backup Neon Databases

# This workflow backs up multiple databases to Cloudflare R2 storage.
# When you fork this repository, add your secrets (R2 credentials, database connections)
# and this workflow will run automatically on schedule or manual trigger.
#
# To configure:
# 1. Add secrets in your fork: Settings → Secrets and variables → Actions
# 2. Customize the schedule, retention, or database list below
# 3. For MySQL/MongoDB, change DATABASE_TYPE and install appropriate client

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup-all:
    name: Backup All Databases
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install PostgreSQL 17 client
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17

      - name: Build and run backup
        env:
          PATH: /usr/lib/postgresql/17/bin:${{ env.PATH }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          DATABASE_TYPE: postgres
          DATABASE_CONNECTION_1: ${{ secrets.DATABASE_CONNECTION_1 }}
          DATABASE_NAME_1: ${{ secrets.DATABASE_NAME_1 }}
          DATABASE_CONNECTION_2: ${{ secrets.DATABASE_CONNECTION_2 }}
          DATABASE_NAME_2: ${{ secrets.DATABASE_NAME_2 }}
          DATABASE_CONNECTION_3: ${{ secrets.DATABASE_CONNECTION_3 }}
          DATABASE_NAME_3: ${{ secrets.DATABASE_NAME_3 }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          COMPRESSION: true
          RETENTION_DAYS: 7
          RETENTION_COUNT: 30
        run: |
          go build -o auto-db-backups .
          ./auto-db-backups
